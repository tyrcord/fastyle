name: Publish Packages

on:
  workflow_dispatch:
  push:
    tags:
      - "fastyle_ad-v[0-9]+.[0-9]+.[0-9]+*"
      - "fastyle_ad_example-v[0-9]+.[0-9]+.[0-9]+*"
      - "fastyle_animation-v[0-9]+.[0-9]+.[0-9]+*"
      - "fastyle_animation_example-v[0-9]+.[0-9]+.[0-9]+*"
      - "fastyle_buttons-v[0-9]+.[0-9]+.[0-9]+*"
      - "fastyle_buttons_example-v[0-9]+.[0-9]+.[0-9]+*"
      - "fastyle_calculator-v[0-9]+.[0-9]+.[0-9]+*"
      - "fastyle_calculator_example-v[0-9]+.[0-9]+.[0-9]+*"
      - "fastyle_charts-v[0-9]+.[0-9]+.[0-9]+*"
      - "fastyle_charts_example-v[0-9]+.[0-9]+.[0-9]+*"
      - "fastyle_connectivity-v[0-9]+.[0-9]+.[0-9]+*"
      - "fastyle_connectivity_example-v[0-9]+.[0-9]+.[0-9]+*"
      - "fastyle_core-v[0-9]+.[0-9]+.[0-9]+*"
      - "fastyle_core_example-v[0-9]+.[0-9]+.[0-9]+*"
      - "fastyle_digit_calculator-v[0-9]+.[0-9]+.[0-9]+*"
      - "fastyle_digit_calculator_example-v[0-9]+.[0-9]+.[0-9]+*"
      - "fastyle_financial-v[0-9]+.[0-9]+.[0-9]+*"
      - "fastyle_financial_example-v[0-9]+.[0-9]+.[0-9]+*"
      - "fastyle_firebase-v[0-9]+.[0-9]+.[0-9]+*"
      - "fastyle_forms-v[0-9]+.[0-9]+.[0-9]+*"
      - "fastyle_forms_example-v[0-9]+.[0-9]+.[0-9]+*"
      - "fastyle_home-v[0-9]+.[0-9]+.[0-9]+*"
      - "fastyle_home_example-v[0-9]+.[0-9]+.[0-9]+*"
      - "fastyle_iap-v[0-9]+.[0-9]+.[0-9]+*"
      - "fastyle_iap_example-v[0-9]+.[0-9]+.[0-9]+*"
      - "fastyle_images-v[0-9]+.[0-9]+.[0-9]+*"
      - "fastyle_images_example-v[0-9]+.[0-9]+.[0-9]+*"
      - "fastyle_layouts-v[0-9]+.[0-9]+.[0-9]+*"
      - "fastyle_onboarding-v[0-9]+.[0-9]+.[0-9]+*"
      - "fastyle_onboarding_example-v[0-9]+.[0-9]+.[0-9]+*"
      - "fastyle_pricing-v[0-9]+.[0-9]+.[0-9]+*"
      - "fastyle_pricing_example-v[0-9]+.[0-9]+.[0-9]+*"
      - "fastyle_quizz-v[0-9]+.[0-9]+.[0-9]+*"
      - "fastyle_quizz_example-v[0-9]+.[0-9]+.[0-9]+*"
      - "fastyle_settings-v[0-9]+.[0-9]+.[0-9]+*"
      - "fastyle_settings_example-v[0-9]+.[0-9]+.[0-9]+*"
      - "fastyle_text-v[0-9]+.[0-9]+.[0-9]+*"
      - "fastyle_video_player-v[0-9]+.[0-9]+.[0-9]+*"
      - "fastyle_views-v[0-9]+.[0-9]+.[0-9]+*"

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      id-token: write # Required for authentication using OIDC

    steps:
      # Checkout the code
      - name: Checkout the code
        uses: actions/checkout@v4

      # Install Flutter
      - name: Install and set Flutter version
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          cache: true

      # Precache Flutter
      - name: Precache Flutter
        run: flutter precache --universal

      # Install Melos
      - name: Install and set Melos version
        uses: bluefireteam/melos-action@v3

      # Install dependencies
      - name: Install dependencies
        run: flutter pub get

      # melos bootstrap
      - name: Bootstrap
        run: melos bootstrap

      # Create publishing token
      - name: Create publishing token (flutter)
        run: |
          set -eo pipefail
          PUB_TOKEN=$(curl --retry 5 --retry-connrefused -sLS "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=https://pub.dev" -H "User-Agent: actions/oidc-client" -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" | jq -r '.value')
          echo "PUB_TOKEN=${PUB_TOKEN}" >> $GITHUB_ENV
          export PUB_TOKEN
          flutter pub token add https://pub.dev --env-var PUB_TOKEN

      # Publish dry run
      - name: Publish - dry run
        run: melos publish --dry-run -y

      # Publishing...
      - name: Publish to pub.dev
        run: melos publish --no-dry-run -y
